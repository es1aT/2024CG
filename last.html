<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>WebGL 最終課題</title>
  <script src="https://unpkg.com/three@0.137.4/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.137.4/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
  <script>
    window.addEventListener('DOMContentLoaded', init);

    function init() {
      // サイズ指定
      const width = 800, height = 600;

      // レンダラーを作成
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      document.body.appendChild(renderer.domElement);
      renderer.shadowMap.enabled = true;

      // シーンとグループを作成
      const scene = new THREE.Scene();
      const atmo = new THREE.Group();
      const landscape = new THREE.Group();

      // カメラを作成
      const camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(0, 20, -35); // 位置を設定
      camera.lookAt(0, 5, 0);

      // カメラコントローラーを作成
      new THREE.OrbitControls(camera, renderer.domElement);

      // テクスチャー読み込み
      const textureLoader = new THREE.TextureLoader();

      // 背景画像を設定（雲が映った空の画像）
      textureLoader.load('sky.png', function (texture) {
        scene.background = texture;
      });

      // 太陽をスプライトで作成
      const sunMat = new THREE.SpriteMaterial({ map: textureLoader.load('sun.png') });
      const sun = new THREE.Sprite(sunMat);
      sun.scale.set(4, 4, 1);
      atmo.add(sun);

      // 太陽の光源を作成
      const sunLight = new THREE.PointLight(0xffffff, 1.5, 1000);
      sunLight.position.copy(sun.position);
      sunLight.castShadow = true;
      atmo.add(sunLight);

      // 時間の経過を表す変数
      let time = 0;

      // 背景色の定義
      const morningC = new THREE.Color(0xffd580); // オレンジ
      const noonC = new THREE.Color(0x87CEEB); // 水色
      const eveC = new THREE.Color(0xffa500); // オレンジ
      const nightC = new THREE.Color(0x000033); // 紺

      // 月を作成
      const moonTex = textureLoader.load('moon.png');
      const moonMat = new THREE.SpriteMaterial({ map: moonTex });
      const moon = new THREE.Sprite(moonMat);
      moon.scale.set(3, 3, 1);
      atmo.add(moon);

      // 月の光源を作成
      const moonLight = new THREE.PointLight(0xffffff, 0.15, 1000);
      moonLight.position.copy(moon.position);
      moonLight.castShadow = true;
      atmo.add(moonLight);

      // 星を作成
      const starsGeo = new THREE.BufferGeometry();
      const starCount = 5000;
      const positions = new Float32Array(starCount * 3);
      for (let i = 0; i < starCount; i++) {
        positions[i * 3] = THREE.Math.randFloatSpread(2000);
        positions[i * 3 + 1] = THREE.Math.randFloatSpread(2000);
        positions[i * 3 + 2] = THREE.Math.randFloatSpread(2000);
      }
      starsGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const starsMat = new THREE.PointsMaterial({ color: 0x888888, size: 3 });
      const starField = new THREE.Points(starsGeo, starsMat);
      atmo.add(starField);

      // 床を作成
      const planeG = new THREE.PlaneGeometry(50, 50);
      const planeM = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0, roughness: 0.9, side: THREE.DoubleSide });
      const plane = new THREE.Mesh(planeG, planeM);
      plane.receiveShadow = true;
      plane.rotation.set(-Math.PI / 2, 0, 0);
      plane.position.set(0, 0, 0);
      landscape.add(plane);

      // 塔部分を作成
      const towerG = new THREE.CylinderGeometry(1.2, 1.5, 8, 32); // 上部半径1、下部半径2、高さ10、セグメント32
      const towerM = new THREE.MeshStandardMaterial({ map: textureLoader.load('kabe.png') });
      const tower = new THREE.Mesh(towerG, towerM);
      tower.position.set(0, 4, 0); // 塔を適切な位置に配置
      landscape.add(tower); // グループに追加

      // 光の下部分を作成
      const toudaiG = new THREE.CylinderGeometry(1.2, 1, 0.8, 32); // 上部にある円筒形の部分
      const toudai = new THREE.Mesh(toudaiG, towerM);
      toudai.position.set(0, 8.45, 0); // 塔の上に配置
      landscape.add(toudai); // グループに追加

      // 上部の光の部分を作成
      const hikariG = new THREE.CylinderGeometry(1.18, 1.18, 1.2, 32);
      const hikariM = new THREE.MeshStandardMaterial({
        color: 0xffffff, transparent: true, opacity: 0.7, roughness: 0.8,
        metalness: 0.1, envMapIntensity: 0.9, bumpScale: 0.1
      });
      const hikari = new THREE.Mesh(hikariG, hikariM);
      hikari.position.set(0, 9.45, 0); // 塔の上に配置
      landscape.add(hikari); // グループに追加

      // 灯台の床部分を作成
      const floorG = new THREE.CylinderGeometry(1.82, 1.82, 0.1, 32); // 屋根の円錐形ジオメトリ
      const floor = new THREE.Mesh(floorG, towerM);
      floor.position.set(0, 8, 0); // 塔の最上部に配置
      landscape.add(floor); // グループに追加

      // 灯台の柵部分を作成
      const sakuG = new THREE.TorusGeometry(1.8, 0.03, 4, 32); // 屋根の円錐形ジオメトリ
      const saku = new THREE.Mesh(sakuG, towerM);
      saku.position.set(0, 8.65, 0); // 塔の最上部に配置
      saku.rotation.set(Math.PI / 2, 0, 0);
      landscape.add(saku); // グループに追加
      const saku2G = new THREE.TorusGeometry(1.8, 0.03, 4, 32); // 屋根の円錐形ジオメトリ
      const saku2 = new THREE.Mesh(saku2G, towerM);
      saku2.position.set(0, 8.325, 0); // 塔の最上部に配置
      saku2.rotation.set(Math.PI / 2, 0, 0);
      landscape.add(saku2); // グループに追加

      // 灯台の屋根部分
      const roofG = new THREE.SphereGeometry(1.2, 43, 43, 0, Math.PI * 2, 0, Math.PI / 2);
      const roof = new THREE.Mesh(roofG, towerM);
      roof.position.set(0, 10, 0); // 塔の最上部に配置
      const poleG = new THREE.CylinderGeometry(0.25, 0.25, 1, 32);
      const pole = new THREE.Mesh(poleG, towerM);
      pole.position.set(0, 10.85, 0); // 塔の最上部に配置
      const ballG = new THREE.SphereGeometry(0.2, 43, 43);
      const ball = new THREE.Mesh(ballG, towerM);
      ball.position.set(0, 11.5, 0); // 塔の最上部に配置
      landscape.add(roof);
      landscape.add(pole);
      landscape.add(ball);

      // ランプの円柱部分を作成
      const lampG = new THREE.CylinderGeometry(0.3, 0.3, 1, 32, 1, true);
      const bodyM = new THREE.MeshStandardMaterial({ color: 0x333333 });
      const capM = new THREE.MeshStandardMaterial({
        color: 0xffff00,
        emissive: 0xffff00,
        emissiveIntensity: 1.0
      });
      const lamp = new THREE.Mesh(lampG, [
        capM, // 上端の面
        capM, // 下端の面
        bodyM  // 胴体部分
      ]);
      lamp.rotation.set(Math.PI / 2, 0, 0); // x軸方向に90度回転
      lamp.position.set(0, 9.45, 0); // ランプの位置を設定
      landscape.add(lamp);

      // 昼と夜の環境光を追加
      const ambLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambLight);

      //グループをsceneに追加
      scene.add(atmo);
      scene.add(landscape);

      // 初回実行（描画処理）
      function update() {
        // 時間の経過を更新
        time += 0.01;

        // 太陽と月の位置を更新
        sun.position.set(30 * Math.cos(time), 10 * Math.sin(time), 30 * Math.sin(time));
        sunLight.position.copy(sun.position);
        moon.position.set(-sun.position.x, -sun.position.y, -sun.position.z);
        moonLight.position.copy(moon.position);

        // 空の色を変化させる
        let sky;
        const sunY = sun.position.y;
        if (sunY > 2) { // 昼間
          sky = noonC;
          starField.visible = false;
          sunLight.intensity = 1.5;
          tgtInt = 0.8;
        } else if (sunY > 0) { // 夕方
          const factor = (2 - sunY) / 2;
          sky = noonC.clone().lerp(eveC, factor);
          starField.visible = false;
          sunLight.intensity = 1.5;
          tgtInt = 0.2;
        } else if (sunY > -2) { // 早朝・夜
          const factor = (2 + sunY) / 2;
          sky = nightC.clone().lerp(eveC, factor);
          starField.visible = true;
          sunLight.intensity = 1.5;
          tgtInt = 0.4;
        } else { // 深夜
          sky = nightC;
          starField.visible = true;
          sunLight.intensity = 0;
          tgtInt = 0.1;
        }
        scene.background = sky;

        // 環境光の強度をゆっくり変化させる
        ambLight.intensity = THREE.MathUtils.lerp(ambLight.intensity, tgtInt, 0.05);


        // ランプを回転させる
        lamp.rotation.z += 0.05; // z軸を中心に回転

        // 背景画像を設定（雲が映った空の画像）
        //textureLoader.load('sky.png', function (texture) {
        //  scene.background = texture;
        //});

        renderer.render(scene, camera);
        requestAnimationFrame(update);
      }

      update();
    }
  </script>
</body>

</html>
