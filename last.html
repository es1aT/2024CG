<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>WebGL 最終課題</title>
  <script src="https://unpkg.com/three@0.137.4/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.137.4/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
  <script>
    window.addEventListener('DOMContentLoaded', init);

    function init() {
      // サイズ指定
      var width = 800,
        height = 600;

      // レンダラーを作成
      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      document.body.appendChild(renderer.domElement);
      renderer.shadowMap.enabled = true;

      // シーンを作成
      var scene = new THREE.Scene();

      // カメラを作成
      var camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(10, 10, 10); // 位置を設定
      camera.lookAt(0, 0, 0);

      // カメラコントローラーを作成
      const controls = new THREE.OrbitControls(camera, renderer.domElement);

      // テクスチャー読み込み
      var textureLoader = new THREE.TextureLoader();

      // 太陽を作成
      const sunGeo = new THREE.SphereGeometry(2, 32, 32);
      const sunTe = textureLoader.load('sun.png');
      const sunMat = new THREE.MeshPhongMaterial({ map: sunTe });
      const sunMesh = new THREE.Mesh(sunGeo, sunMat);
      sunMesh.castShadow = true;
      scene.add(sunMesh);

      // 太陽の光源を作成
      var sunLight = new THREE.PointLight(0xffffff, 1.5, 1000);
      sunLight.castShadow = true;
      scene.add(sunLight);

      // 月を作成
      const moonGeometry = new THREE.SphereGeometry(1.5, 32, 32);
      const moonTexture = textureLoader.load('moon.png');
      const moonMaterial = new THREE.MeshPhongMaterial({ map: moonTexture });
      const moon = new THREE.Mesh(moonGeometry, moonMaterial);
      moon.castShadow = true;
      scene.add(moon);

      // 星を作成
      const starsGeometry = new THREE.BufferGeometry();
      const starCount = 5000;
      const positions = new Float32Array(starCount * 3);
      for (let i = 0; i < starCount; i++) {
        positions[i * 3] = THREE.Math.randFloatSpread(2000);
        positions[i * 3 + 1] = THREE.Math.randFloatSpread(2000);
        positions[i * 3 + 2] = THREE.Math.randFloatSpread(2000);
      }
      starsGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const starsMaterial = new THREE.PointsMaterial({ color: 0x888888, size: 3 });
      const starField = new THREE.Points(starsGeometry, starsMaterial);
      scene.add(starField);

      // 床を作成
      var planeG = new THREE.PlaneGeometry(10, 10);
      var planeM = new THREE.MeshStandardMaterial({ color: 0x808080, metalness: 0, roughness: 0.9, side: THREE.DoubleSide });
      var plane = new THREE.Mesh(planeG, planeM);
      plane.receiveShadow = true; //影がつく
      plane.rotation.set(-Math.PI / 2, 0, 0);
      plane.position.set(0, 0, 0);
      scene.add(plane);

      // 箱を作成
      var geometry = new THREE.BoxGeometry(2, 2, 2);
      var material = new THREE.MeshPhongMaterial({ color: 0xffffff });
      var box = new THREE.Mesh(geometry, material);
      box.position.y = 2;
      box.castShadow = true;
      scene.add(box);

      // 環境光を追加
      const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
      scene.add(ambientLight);

      // 時間の経過を表す変数
      let time = 0;

      // 背景色の定義
      const morningColor = new THREE.Color(0xffa500); // オレンジ
      const noonColor = new THREE.Color(0x87CEEB); // 青
      const eveningColor = new THREE.Color(0xffa500); // オレンジ
      const nightColor = new THREE.Color(0x000033); // 黒

      // 背景色を補間する関数
      function interpolateColor(color1, color2, factor) {
        const result = color1.clone();
        result.lerp(color2, factor);
        return result;
      }

      // 初回実行（描画処理）
      var update = function () {
        // 時間の経過を更新
        time += 0.01;

        // 太陽の位置を更新
        sunMesh.position.x = 50 * Math.cos(time);
        sunMesh.position.y = 50 * Math.sin(time);
        sunMesh.position.z = 50 * Math.sin(time);

        sunLight.position.copy(sunMesh.position);

        // 月の位置を太陽の逆位置に設定
        moon.position.x = -sunMesh.position.x;
        moon.position.y = -sunMesh.position.y;
        moon.position.z = -sunMesh.position.z;

        // 太陽の色と空の色を変化させる
        let backgroundColor;

        if (sunMesh.position.y > 5) {
          // 昼間
          backgroundColor = noonColor;
          starField.visible = false;
        } else if (sunMesh.position.y > 0) {
          // 朝または夕方
          const factor = (5 - sunMesh.position.y) / 5;
          if (time % (2 * Math.PI) < Math.PI) {
            backgroundColor = interpolateColor(noonColor, eveningColor, factor);
          } else {
            backgroundColor = interpolateColor(morningColor, noonColor, factor);
          }
          starField.visible = false;
        } else if (sunMesh.position.y > -5) {
          // 夕方または朝
          const factor = (5 + sunMesh.position.y) / 5;
          if (time % (2 * Math.PI) < Math.PI) {
            backgroundColor = interpolateColor(eveningColor, nightColor, factor);
          } else {
            backgroundColor = interpolateColor(nightColor, morningColor, factor);
          }
          starField.visible = true;
        } else {
          // 夜
          backgroundColor = nightColor;
          starField.visible = true;
        }

        scene.background = backgroundColor;

        renderer.render(scene, camera);
        requestAnimationFrame(update);
      };

      update();
    }
  </script>
</body>

</html>
